.SUFFIXES: .F .o

OBJS = mpas_oac_mpas_core.o

all: oac_shared ocean_shared core_oac

ocean_shared:
	( cd ../core_ocean; $(MAKE) CPPFLAGS="$(CPPFLAGS)" CPPINCLUDES="$(CPPINCLUDES)" ocean_shared ) 
	ln -sf ../core_ocean/*.mod .

oac_shared:  ocean_shared
	( cd shared_oac; $(MAKE) CPPFLAGS="$(CPPFLAGS)" CPPINCLUDES="$(CPPINCLUDES)" all ) 
	ln -sf shared_oac/*.mod .

core_oac: $(OBJS)  
	ar -ru libdycore.a  $(OBJS) ../core_ocean/*.o shared_oac/*.o

core_reg:
	tail -n +3 ../core_ocean/Registry.xml | head -n -2 > Registry_shared_ocean_temporary.xml
	$(CPP) $(CPPFLAGS) $(CPPINCLUDES) Registry.xml > Registry_processed.xml

mpas_ocn_mpas_core.o: ocean_shared oac_shared

clean:
	$(RM) *.o *.mod *.f90 libdycore.a
	$(RM) Registry_processed.xml Registry_shared_ocean_temporary.xml
	(cd shared_oac; make clean)

.F.o:
	$(RM) $@ $*.mod
ifeq "$(GEN_F90)" "true"
	$(CPP) $(CPPFLAGS) $(CPPINCLUDES) $< > $*.f90
	$(FC) $(FFLAGS) -c $*.f90 $(FCINCLUDES) -I../framework -I../operators -I../external/esmf_time_f90 
else
	$(FC) $(CPPFLAGS) $(FFLAGS) -c $*.F $(CPPINCLUDES) $(FCINCLUDES) -I../framework -I../operators -I../external/esmf_time_f90 
endif
