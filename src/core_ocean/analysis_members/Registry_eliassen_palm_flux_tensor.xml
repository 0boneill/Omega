<nml_record name="eliassen_palm_flux_tensor" mode="forward;analysis">
  <nml_option name="config_use_eliassen_palm_flux_tensor" 
    type="logical" 
    default_value=".false." 
    units="unitless"
    description="If true, ocean analysis member eliassen_palm_flux_tensor is called."
    possible_values=".true. or .false."
  />
  <nml_option name="config_epft_reset" 
    type="logical" 
    default_value=".false." 
    units="unitless"
		description="If true, all EPfT fields in the restart file are re-initialized to zero"
		possible_values=".true. or .false."
		/>
  <nml_option name="config_eliassen_palm_flux_tensor_compute_interval" 
      type="character" 
      default_value="same_as_output" 
      units="unitless"
      description="Timestamp determining how often analysis member computation should be performed."
      possible_values="'DDDD_HH:MM:SS', 'same_as_output'"
    />
  <nml_option name="config_eliassen_palm_flux_tensor_compute_startup" 
      type="logical" 
      default_value=".true." 
      units="unitless"
      description="Logical flag determining if an analysis member computation occurs on start-up."
      possible_values=".true. or .false."
    />
  <nml_option name="config_eliassen_palm_flux_tensor_directory" 
      type="character" 
      default_value="analysis_members"
      units="unitless"
      description="subdirectory to write Elliassen-Palm flux tensor files"
      possible_values="any valid directory name"
  />
  <nml_option name="config_eliassen_palm_flux_tensor_debug" 
      type="logical" 
      default_value=".false." 
      units="unitless"
      description="If true, debugging code is turned on."
      possible_values=".true. or .false."
  />
  <nml_option name="config_nBuoyancyLayers" 
      type="integer" 
      default_value="45"
      units="-"
      description="Number of reference buoyancy layers."
      possible_values="any positive real value."
  />
  <nml_option name="config_rhomin_buoycoor" 
      type="real" 
      default_value="900" 
      units="kg m^{-3}"
      description="Minimum density used in defining the first buoyancy coordinate layer"
      possible_values="any positive real value."
  />
  <nml_option name="config_rhomax_buoycoor" 
      type="real" 
      default_value="1080" 
      units="kg m^{-3}"
      description="Maximum density used in defining the last buoyancy coordinate layer"
      possible_values="any positive real value."
  />
</nml_record>

<dims>
  <dim name="nBuoyancyLayers" 
    definition="namelist:config_nBuoyancyLayers"
    description="The number of buoyancy layers used for buoyancy coordinates."
  />
  <dim name="nBuoyancyLayersP1" 
    definition="nBuoyancyLayers+1"
    description="The number of interfaces between buoyancy layers used for buoyancy coordinates."
  />
</dims>


<packages>
  <package name="amEliassenPalmFluxTensorPkg" 
    description="This package includes variables required for the amEliassenPalmFluxTensor analysis member."/>
</packages>
  
<streams>

  <stream name="eliassenPalmFluxTensorInput" 
    type="input"
    mode="forward;analysis"
    filename_template="eliassen_palm_flux_tensor_input.$Y-$M-$D.nc"
    filename_interval="01-00-00_00:00:00"
    output_interval="00-00-01_00:00:00"
    packages="amEliassenPalmFluxTensorPkg"
    clobber_mode="truncate"
    runtime_format="single_file">
    <var name="xtime"/> 
    <var name="potentialDensityMidRef"/> 
  </stream>
  
  <stream name="eliassenPalmFluxTensorOutput" 
    type="output"
    mode="forward;analysis"
    filename_template="analysis_members/eliassen_palm_flux_tensor_output.$Y-$M-$D.nc"
    filename_interval="01-00-00_00:00:00"
    output_interval="00-00-01_00:00:00"
    packages="amEliassenPalmFluxTensorPkg"
    clobber_mode="truncate"
    runtime_format="single_file">
    <var name="xtime"/> 
    <var name="potentialDensityMidRef"/> 
    <var name="potentialDensityTopRef"/> 
    <var name="nSamplesEA"/> 
    <var name="buoyancyMaskEA"/> 
    <var name="sigmaEA"/> 
    <var name="heightMidBuoyCoorEA"/> 
    <var name="heightTopBuoyCoorEA"/> 
    <var name="heightMidBuoyCoorSqEA"/> 
    <var name="montgPotBuoyCoorEA"/> 
    <var name="montgPotGradZonalEA"/> 
    <var name="montgPotGradMeridEA"/> 
    <var name="heightMGradZonalEA"/> 
    <var name="heightMGradMeridEA"/> 
    <var name="uusigmaEA"/> 
    <var name="vvsigmaEA"/> 
    <var name="uvsigmaEA"/> 
    <var name="uwsigmaEA"/> 
    <var name="vwsigmaEA"/> 
    <var name="uTWA"/> 
    <var name="vTWA"/> 
    <var name="wTWA"/> 
    <var name="EPFT"/> 
    <var name="divEPFT"/> 
    <var name="ErtelPVFlux"/> 
    <var name="ErtelPVTendency"/> 
    <var name="ErtelPV"/> 
  </stream>

  <stream name="eliassenPalmFluxTensorRestart" 
    type="input;output"
    mode="forward;analysis"
    filename_template="restarts/eliassen_palm_flux_tensor_restart.$Y-$M-$D.nc"
    filename_interval="01-00-00_00:00:00"
    output_interval="00-00-01_00:00:00"
    packages="amEliassenPalmFluxTensorPkg"
    clobber_mode="truncate"
    runtime_format="single_file">
    <var name="xtime"/> 
    <var name="nSamplesEA"/> 
    <var name="buoyancyMaskEA"/> 
    <var name="sigmaEA"/> 
    <var name="potentialDensityMidRef"/> 
    <var name="heightMidBuoyCoorEA"/> 
    <var name="heightTopBuoyCoorEA"/> 
    <var name="heightMidBuoyCoorSqEA"/> 
    <var name="montgPotBuoyCoorEA"/> 
    <var name="montgPotGradZonalEA"/> 
    <var name="montgPotGradMeridEA"/> 
    <var name="heightMGradZonalEA"/> 
    <var name="heightMGradMeridEA"/> 
    <var name="usigmaEA"/> 
    <var name="vsigmaEA"/> 
    <var name="uusigmaEA"/> 
    <var name="vvsigmaEA"/> 
    <var name="uvsigmaEA"/> 
    <var name="uwsigmaEA"/> 
    <var name="vwsigmaEA"/> 
  </stream>
</streams>
  
<var_struct name="eliassenPalmFluxTensorScratch" time_levs="1">
  <var name="heightMidBuoyCoor" 
    type="real" 
    streams="o" 
    dimensions="nBuoyancyLayers nCells Time" 
    units="m"
		description="Height (z-coordinate) of buoyancy layer"
  />
  <var name="heightTopBuoyCoor" 
    type="real" 
    streams="o"
    dimensions="nBuoyancyLayers nCells Time" 
    units="m"
		description="Height (z-coordinate) at top of buoyancy layer"
		/>
  <var name="heightInterfaceBuoyCoor" 
    type="real" 
    streams="o" 
    dimensions="nBuoyancyLayersP1 nCells Time" 
    units="m"
		description="Height (z-coordinate) of the interfaces of buoyancy layer"
	/>
  <var name="sigma" 
    type="real"
    streams="o" 
    dimensions="nBuoyancyLayers nCells Time" 
    units="s^{-2}"
		description="Inverse of the derivative of buoyancy wrt z, aka thickness, in buoyancy coordinates"
  />
  <var name="montgPotBuoyCoor" 
    type="real" 
    streams="o" 
		dimensions="nBuoyancyLayers nCells Time" units="m^2 s^{-2}"
		description="Montgomery potential in buoyancy coordinates"
	/>
  <var name="montgPotNormalGradOnEdge" 
    type="real" 
    streams="o" 
		dimensions="nBuoyancyLayers nEdges Time" units="m s^{-2}"
		description="Normal gradient of the montgomery potential in buoyancy coordinates"
	/>
  <var name="uMidBuoyCoor" 
    type="real" 
    streams="o" 
    dimensions="nBuoyancyLayers nCells Time" 
    units="m s^{-1}"
		description="Longitudinal velocity at middle of layers in buoyancy coordinates"
	/>
  <var name="vMidBuoyCoor" 
    type="real" 
    streams="o" 
    dimensions="nBuoyancyLayers nCells Time" 
    units="m s^{-1}"
		description="Meridional velocity at the middle of layers in buoyancy coordinates"
	/>
  <var name="densityMidBuoyCoor" 
    type="real" 
    streams="o" 
    dimensions="nBuoyancyLayers nCells Time" 
    units="m s^{-1}"
		description="In-situ density at middle of layers in buoyancy coordinates"
		/>
  <var name="densityTopBuoyCoor" 
    type="real" 
    streams="o" 
    dimensions="nBuoyancyLayers nCells Time" 
    units="m s^{-1}"
		description="In-situ density at top of layers in buoyancy coordinates"
	/>
  <var name="firstLayerBuoyCoor" 
    type="integer" 
    streams="o"
    dimensions="nCells Time" 
    units="-"
		description="index, in buoyancy coordinates, of the first layer in column for a given cell"
	/>
  <var name="lastLayerBuoyCoor" 
    type="integer" 
    streams="o" 
    dimensions="nCells Time" 
    units="-"
		description="index, in buoyancy coordinates, of the last layer in column for a given cell"
	/>
  <var name="buoyancyMask" 
    type="real" 
    streams="o" 
    dimensions="nBuoyancyLayers nCells Time" 
    units="-"
		description="mask in buoyancy coordinates, ocean cells are 1"
	/>
  <var name="montgPotGradX" 
    type="real" 
    streams="o"
    dimensions="nBuoyancyLayers nCells Time" 
    units="m s^{-2}"
		description="x component of gradient of montgomery potential at cell center in buoyancy coordinates"
	/>
  <var name="montgPotGradY" 
    type="real" 
    streams="o"
    dimensions="nBuoyancyLayers nCells Time" 
    units="m s^{-2}"
		description="y component of gradient of montgomery potential at cell center in buoyancy coordinates"
		/>
	<var name="montgPotGradZ" 
    type="real" 
    streams="o"
		dimensions="nBuoyancyLayers nCells Time" units="m s^{-2}"
		description="z component of gradient of montgomery potential at cell center in buoyancy coordinates"
	/>
  <var name="montgPotGradZonal" 
    type="real" 
    streams="o"
		dimensions="nBuoyancyLayers nCells Time" 
    units="m s^{-2}"
		description="Zonal component of gradient of montgomery potential at cell center in buoyancy coordinates"
		/>
  <var name="montgPotGradMerid" 
    type="real" 
    streams="o"
    dimensions="nBuoyancyLayers nCells Time" 
    units="m s^{-2}"
		description="Meridional component of gradient of montgomery potential at cell center in buoyancy coordinates"
	/>
  <var name="wrk3DnVertLevelsP1" 
    type="real" 
    streams="o"
    dimensions="nVertLevelsP1 nCells" 
    units="unitless" 
    description="work array"
	/>
  <var name="wrk3DnVertLevels" 
    type="real" 
    streams="o"
    dimensions="nVertLevels nCells" 
    units="unitless" 
    description="work array"
	/>
  <var name="wrk3DBuoyCoor" 
    persistence="scratch" 
    type="real" 
    dimensions="nBuoyancyLayers nCells" 
    units="unitless" 
    description="work array"
	/>
  <!-- 
  Test variables 
  -->
  <var name="array1_3D" 
    type="real"
    dimensions="nVertLevels nCells Time" 
    streams="" 
    units="-"
		description="test array 1, in depth coordinates"
	/>
  <var name="array2_3D" 
    type="real"
    dimensions="nVertLevels nCells Time" 
    streams="" 
    units="-"
		description="test array 2, in depth coordinates"
	/>
  <var name="array3_3D" 
    type="real"
    dimensions="nVertLevels nCells Time" 
    streams="" 
    units="-"
		description="test array 3, in depth coordinates"
	/>
  <var name="array1_3Dbuoy" 
    type="real"
    dimensions="nBuoyancyLayers nCells Time" 
    streams="" 
    units="-"
		description="test array 1, in buoyancy coordinates"
	/>
  <var name="array2_3Dbuoy" 
    type="real"
    dimensions="nBuoyancyLayers nCells Time" 
    streams="" 
    units="-"
		description="test array 2, in buoyancy coordinates"
	/>
  <var name="PVMidBuoyCoor" 
    type="real"
    dimensions="nBuoyancyLayers nCells Time" 
    streams="" 
    units="-"
		description="Potential vorticity at cell center, in buoyancy coordinates"
	/>
  <var name="PVMidBuoyCoorEA" 
    type="real"
    dimensions="nBuoyancyLayers nCells Time" 
    streams="" 
    units="-"
		description="Potential vorticity at cell center, in buoyancy coordinates, ensemble average"
	/>
  <var name="uMidBuoyCoorEA" 
    type="real"
    dimensions="nBuoyancyLayers nCells Time" 
    streams="" 
    units="-"
		description="Zonal velocity at cell center, in buoyancy coordinates, ensemble average"
	/>
  <var name="vMidBuoyCoorEA" 
    type="real"
    dimensions="nBuoyancyLayers nCells Time" 
    streams="" 
    units="-"
		description="Meridional velocity at cell center, in buoyancy coordinates, ensemble average"
	/>
  <var name="uPVMidBuoyCoorEA" 
    type="real"
    dimensions="nBuoyancyLayers nCells Time" 
    streams="" 
    units="-"
		description="Zonal velocity times Potential vorticity at cell center, in buoyancy coordinates, ensemble average"
	/>
  <var name="vPVMidBuoyCoorEA" 
    type="real"
    dimensions="nBuoyancyLayers nCells Time" 
    streams="" 
    units="-"
		description="Meridional velocity times Potential vorticity at cell center, in buoyancy coordinates, ensemble average"
	/>
  <var name="PVFluxTest" 
    type="real"
    dimensions="TWO nBuoyancyLayers nCells Time" 
    streams="o" 
    units="-"
		description="Potential vorticity flux test vector, in buoyancy coordinates"
	/>
</var_struct>

<var_struct name="amEliassenPalmFluxTensor" 
  time_levs="1"
  packages="amEliassenPalmFluxTensorPkg">
  <var name="potentialDensityMidRef" 
    type="real" 
    dimensions="nBuoyancyLayers" 
    streams="iro" 
    units="kg m^{-3}" 
    description="Potential density target values of buoyancy coordinate layers"
  />
  <var name="potentialDensityTopRef" 
    type="real" 
    dimensions="nBuoyancyLayers" 
    streams="o" 
    units="kg m^{-3}"
    description="Potential density at top of buoyancy coordinate layers"
  />
  <var name="buoyancyMidRef" 
    type="real" 
    dimensions="nBuoyancyLayers" 
    streams="o" 
    units="m s^{-2}"
    description="Buoyancy of buoyancy coordinate layers"
  />
  <var name="buoyancyInterfaceRef" 
    type="real" 
    dimensions="nBuoyancyLayersP1" 
    streams="o" 
    units="m s^{-2}"
    description="Buoyancy at interfaces of buoyancy coordinate layers"
  />
  <var name="buoyancyMaskEA" 
    type="real" 
    streams="ro"
    dimensions="nBuoyancyLayers nCells Time" 
    units="-"
    description="ensemble average of the buoyancy mask"
  />
  <var name="sigmaEA" 
    type="real" 
    dimensions="nBuoyancyLayers nCells Time" 
    streams="ro" 
    units="s^{-2}"
    description="Inverse of the derivative of buoyancy wrt z, or thickness per unit buoyancy, aka thickness, in buoyancy coordinates, ensemble average"
  />
  <var name="nSamplesEA" 
    type="integer" 
    dimensions="Time" 
    streams="ro" 
    units="-"
    description="Number of samples used in the ensamble average"
  />
  <var name="heightMidBuoyCoorEA" 
    type="real"
    dimensions="nBuoyancyLayers nCells Time" 
    streams="ro" 
    units="m"
    description="z-coordinate of each buoyancy layer, ensemble average"
  />
  <var name="heightTopBuoyCoorEA" 
    type="real" 
    dimensions="nBuoyancyLayers nCells Time"
    streams="ro" 
    units="m"
    description="z-coordinate at top of each buoyancy layer, ensembele average"
  />
  <var name="montgPotGradZonalEA" 
    type="real" 
    dimensions="nBuoyancyLayers nCells Time" 
    streams="ro" 
    units="m"
    description="Zonal gradient of montgomery potential at cell center in buoyancy coordinates, ensemble average"
  />
  <var name="montgPotGradMeridEA" 
    type="real" 
    dimensions="nBuoyancyLayers nCells Time" 
    streams="ro" 
    units="m"
    description="Meridional gradient of montgomery potential at cell center in buoyancy coordinates, ensemble average"
  />
  <var name="heightMidBuoyCoorSqEA" 
    type="real" 
    dimensions="nBuoyancyLayers nCells Time" 
    streams="ro" 
    units="m^2"
    description="z-coordinate of each buoyancy layer, squared, ensemble average"
  />
  <var name="montgPotBuoyCoorEA" 
    type="real" 
    dimensions="nBuoyancyLayers nCells Time" 
    streams="ro" 
    units="m^2 s^{-2}"
    description="Montgomery potential in buoyancy coordinates, ensemble average"
  />
  <var name="HeightMGradZonalEA" 
    type="real" 
    dimensions="nBuoyancyLayers nCells Time" 
    streams="ro" 
    units="m^2 s^{-2}"
    description="Height times zonal gradient of Montgomery potential in buoyancy coordinates, ensemble average"
  />
  <var name="HeightMGradMeridEA" 
    type="real" 
    dimensions="nBuoyancyLayers nCells Time" 
    streams="ro" 
    units="m^2 s^{-2}"
    description="Height times meridional gradient of Montgomery potential in buoyancy coordinates, ensemble average"
  />
  <var name="usigmaEA" 
    type="real" 
    dimensions="nBuoyancyLayers nCells Time" 
    streams="ro"
    units="m^2 s^{-2}"
    description="Zonal velocity times sigma, ensemble average"
  />
  <var name="vsigmaEA" 
    type="real" 
    dimensions="nBuoyancyLayers nCells Time" 
    streams="ro" 
    units="m^2 s^{-2}"
    description="Meridional velocity times sigma, ensemble average"
  />
  <var name="uusigmaEA" 
    type="real" 
    dimensions="nBuoyancyLayers nCells Time" 
    streams="ro" 
    units="m^2 s^{-2}"
    description="Zonal velocity times zonal velocity times sigma, ensemble average"
  />
  <var name="vvsigmaEA" 
    type="real" 
    dimensions="nBuoyancyLayers nCells Time" 
    streams="ro" 
    units="m^2 s^{-2}"
    description="Meridional velocity times meridional velocity times sigma, ensemble average"
  />
  <var name="uvsigmaEA" 
    type="real" 
    dimensions="nBuoyancyLayers nCells Time" 
    streams="ro"
    units="m^2 s^{-2}"
    description="Zonal velocity times meridional velocity times sigma, ensemble average"
  />
  <var name="uwsigmaEA" 
    type="real" 
    dimensions="nBuoyancyLayers nCells Time" 
    streams="ro" 
    units="m^2 s^{-2}"
    description="Zonal velocity times vertical velocity in buoyancy coordinates times sigma, ensemble average"
  />
  <var name="vwsigmaEA" 
    type="real" 
    dimensions="nBuoyancyLayers nCells Time" 
    streams="ro" 
    units="m^2 s^{-2}"
    description="Meridional velocity times vertical velocity in buoyancy coordinates times sigma, ensemble average"
  />
  <var name="uTWA" 
    type="real" 
    dimensions="nBuoyancyLayers nCells Time" 
    streams="o" 
    units="m s^{-1}"
    description="Zonal velocity, thickness weighted"
  />
  <var name="vTWA" 
    type="real" 
    dimensions="nBuoyancyLayers nCells Time" 
    streams="o" 
    units="m s^{-1}"
    description="Meridional velocity, thickness weighted"
  />
  <var name="wTWA" 
    type="real" 
    dimensions="nBuoyancyLayers nCells Time" 
    streams="o" 
    units="m s^{-3}"
    description="Vertical velocity, thickness weighted"
  />
  <var name="EPFT" 
    type="real" 
    dimensions="THREE THREE nBuoyancyLayers nCells Time" 
    streams="" 
    units="m^2 s^{-2}"
    description="Eliassen-Palm flux tensor"
  />
  <var name="divEPFT" 
    type="real" 
    dimensions="THREE nBuoyancyLayers nCells Time" 
    streams="o" 
    units="m s^{-2}"
    description="Divergence of the Eliassen-Palm flux tensor, in buoyancy coordinates"
  />
  <var name="ErtelPVFlux" 
    type="real" 
    dimensions="THREE nBuoyancyLayers nCells Time" 
    streams="o" 
    units="m"
    description="Ertel potential vorticity flux in buoyancy coordinates"
  />
  <var name="ErtelPVTendency" 
    type="real" 
    dimensions="nBuoyancyLayers nCells Time" 
    streams="o" 
    units="s s^{-1}"
    description="Tendency of Ertel PV due to divergence of eddy PV fluxes"
  />
<var name="ErtelPV" 
    type="real" 
    dimensions="nBuoyancyLayers nCells Time" 
    streams="o" 
    units="s"
    description="Ertel PV on buoyancy surfaces"
  />
</var_struct>

