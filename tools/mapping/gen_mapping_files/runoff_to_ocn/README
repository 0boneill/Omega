===============
ABOUT THIS TOOL
===============

The src/ directory here contains F90 files and a Makefile to produce the
runoff_map executable. The executable reads runoff_map.nml and produces three
maps:

1) An initial nearest neighbor mapping from the rof grid to the coastal ocean
   grid
2) A smoothing map from the coastal ocean grid to the global ocean grid
3) The product of the two, a smooth map from the rof grid to the global ocean
   grid

The ncl/ directory contains an NCL script to compute a fourth map (which is
actually a combination of two existing maps):

4) Map (1) from above for rof grid cells where closest ocean coastal cell in
   in the open ocean, or map (3) if the nearest ocean coastal cell is in a
   marginal sea

====================
HOW TO USE THIS TOOL
====================

1) Build (see the INSTALL file in this directory for details)
2) Setup a namelist file (see any of runoff_map_*.nml for an example)
3) Run with the following command:
$ ./runoff_map < [namelist file]
4) Run ./run_merge_mapping_files.sh (will produce map 4)

============
HOW TO BUILD
============

See INSTALL file in this directory

====================
NAMELIST FILE FORMAT
====================

The namelist file must be called "runoff_map.nml".  That name is hardwired
into the executable.

The namelist looks like this

  &input_nml
   gridtype              = 'scrip'
   file_roff             = '/glade/p/cesm/cseg/mapping/grids/wr50a_090614.nc'
   file_ocn_coastal_mask = '/glade/p/cesm/cseg/mapping/grids/ar9v4_100920.nc'
   file_ocn_global_mask  = '/glade/p/cesm/cseg/mapping/grids/ar9v4_100920.nc'
   file_nn               = 'map_wr50a_ar9v4_nn.nc '
   file_smooth           = 'map_ar9v4_ar9v4_smoother.nc '
   file_new              = 'map_wr50a_to_ar9v4_e1000r300_130507.nc'
   title                 = 'runoff map: wr50a -> ar9v4, smoothed '
   eFold                 = 1000000.0
   rMax                  =  300000.0
   step1 = .true.
   step2 = .false.
   step3 = .false.
  /

where

Input grid files:
  gridtype  =  type of file_roff file, "rtm" or "obs" or "scrip"
     rtm is a 720 x 360 grid ascii file
     obs is a netcdf file with xc, yc, xv, yv, mask and area variable names
     scrip is a scrip type grid file (must contain grid_area along with typical
       scrip grid variables)
  file_roff =   an ascii rdirc file OR an obs rtm file OR a scrip grid file
  file_ocn_coastal_mask  =  a scrip ocean grid file where the mask is only 1
                            for coastal grid cells
  file_ocn_global_mask   =  a scrip ocean grid file where the mask is 1 for
                            all ocean grid cells
NOTE: both file_ocn_* variables must contain grid_area along with typical scrip
      grid variables

Input parameters:
  eFold  = smoothing eFold distance in meters
  rMax   = maximum radius of effect in meters

Settings:
  title = ascii string to add to mapping files
  step1 = computes nearest neighbor map
  step2 = computes smooth map
  step3 = multiple two maps together

Output fields:
  file_nn     = nearest neighbor mapping file
  file_smooth = smoother mapping file
  file_new    = combined file


==========
HOW TO RUN
==========

Execute the binary ./runoff_map (again, this will read the runoff_map.nml
namelist file - see above section for tips on creating the file)

