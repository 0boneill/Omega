#!/usr/bin/env python

import xml.etree.ElementTree as ElementTree
import xml.dom
import argparse
import os, glob, re
import urllib
import urllib2
import json
testdburl = "https://csegwebdev.cgd.ucar.edu/testdb/cgi-bin/processXMLtest.cgi"

class CimeTestStatus():
    def __init__(self, testname):
        self.testname = testname
        self.testcomparestatus = ''
        self.baselinecomparestatus = ''
    def testLine(self):
        return self.overallstatus + " " + self.testname
    def testStatus(self):
        return self.overallstatus +  " " + self.testname  + "\n" + self.output

class CimeTestStatusEncoder(json.JSONEncoder):
    def default(self, obj):
        if isinstance(obj, CimeTestStatus):
            return {"testname" : obj.testname, "status" : obj.overallstatus, "output" : obj.output}
        return json.JSONEncoder.default(self, obj)
# we need to write CDATA tags as part of the xml processing, 
# unfortunately, ElementTree doesn't do CDATA
def CDATA(text=None):
    element = etree.Element('![CDATA[')
    element.text = text
    return element

ElementTree._original_serialize_xml = ElementTree._serialize_xml

def _serialize_xml(write, elem, encoding, qnames, namespaces):
    if elem.tag == '![CDATA[':
        write("\n{}{}]]>\n".format(elem.tag, elem.text))
        if elem.tail:
            write(_escape_cdata(elem.tail))
    else:
        return ElementTree._original_serialize_xml(write, elem, qnames, namespaces, short_empty_elements, **kwargs)

ElementTree._serialize_xml = ElementTree._serialize['xml'] = _serialize_xml

        
#------------------------------------------------------------------------------
# Read the test spec, get relevant test info 
#------------------------------------------------------------------------------
def getSuiteInfo(args):
    
    
    if args.testid: 
        xmlfile = "testspec." + args.testid + ".xml"
        print xmlfile
    else:
        for file in glob.glob("testspec*xml"):
            xmlfile = file
    
    tree = ElementTree.parse(xmlfile)
    root = tree.getroot()
    suiteinfo = {}
    testlist = []
    
    for tr in root.findall('testroot'):
        suiteinfo['testroot'] = tr.text    
    
    for cr in root.findall('cimeroot'):
        suiteinfo['cimeroot'] = cr.text
    
    for bltag in root.findall('baselinetag'):
        suiteinfo['baselinetag'] = bltag.text
    
    for compiler in root.findall("compiler"):
        suiteinfo['compiler'] = compiler.text
    
    for mpilib in root.findall('mpilib'):
        suiteinfo['mpilib'] = mpilib.text
    
    for mach in root.findall('mach'):
        suiteinfo['machine'] = mach.text

    print suiteinfo
    
    for t in root.findall('test'):
        testlist.append(t.attrib['case'])
    
    suiteinfo['testlist'] = testlist
    return suiteinfo
            
#------------------------------------------------------------------------------
# Get the status of each test
#------------------------------------------------------------------------------
def getTestStatuses(suiteinfo):
    
    cimetests = []
    for test in suiteinfo['testlist']:
        cimeteststatus = CimeTestStatus(test)
        statusfilename = test + "/TestStatus"

        
        # Read only the first line, then split the first line by 
        # whitespace, set the status as the first field of the split
        with open(statusfilename, 'r') as f:
            first_line = f.readline()
            #cimeteststatus.setStatus(first_line.split()[0])
            cimeteststatus.overallstatus = first_line.split()[0]
            rest_of_file = f.read()
            cimeteststatus.output = rest_of_file
            cimetests.append(cimeteststatus)
        f.close()
    
        lines = cimeteststatus.output.splitlines()
        
        testcompareoutput = ''
        baselinecompareoutput = ''
        for line in lines:
            if "test compare" in line:
                testcompareoutput += (line + "\n")
            if "baseline compare" in line:
                baselinecompareoutput += (line + "\n")
        cimeteststatus.testcompareoutput = testcompareoutput
        cimeteststatus.baselinecompareoutput = baselinecompareoutput
    
        testcomparefailoutput = ''
        for line in cimeteststatus.testcompareoutput.splitlines():
            if "FAIL" in line:
                cimeteststatus.overallstatus = 'FAIL'
                cimeteststatus.testcomparestatus = 'FAIL'
                testcomparefailoutput += (line + "\n")
        cimeteststatus.testcomparefailoutput = testcomparefailoutput
    
        baselinecomparefailoutput = ''
        for line in cimeteststatus.baselinecompareoutput.splitlines():
            if "FAIL" in line:
                cimeteststatus.baselinecomparestatus = 'FAIL'
                baselinecomparefailoutput += (line + "\n")
        cimeteststatus.baselinecomparefailoutput = baselinecomparefailoutput

    return cimetests

def printStatus(cimetests):
    for test in cimetests:
        #print CimeTestStatusEncoder().encode(test)
        print test.testStatus()    

def printSummary(suiteinfo, cimetests):

    banner = '=' * 80
    
    testcomparefails = []
    baselinecomparefails = []
    for t in cimetests:
        if t.testcomparestatus == 'FAIL':
            testcomparefails.append(t)
        if t.baselinecomparestatus == 'FAIL':
            baselinecomparefails.append(t)
    cfails = [t for t in cimetests if t.overallstatus == 'CFAIL']
    passes = [t for t in cimetests if t.overallstatus == 'DONE']
    sfails = [t for t in cimetests if t.overallstatus == 'SFAIL']
    runs =   [r for r in cimetests if r.overallstatus == 'RUN' ]
    print banner
    print "Test Summary "
    if passes: 
        print "{} Tests passed".format(len(passes))
    if testcomparefails:
        print "{} Tests failed the history file comparison".format(len(testcomparefails))
    if baselinecomparefails:
        print "{} Tests failed the baseline comparison".format(len(baselinecomparefails))
    if sfails:
        print "{} Tests had script errors".format(len(sfails))
    if cfails:
        print "{} Tests had compile fails".format(len(cfails))
    if runs:
        print "{} Tests failed to finish running".format(len(runs))
    print banner
    
    if testcomparefails:
        print banner
        print "The following tests failed the history file comparison:"
        print banner
        for t in testcomparefails:
            print t.testLine()
            print t.baselinecomparefailoutput
        print banner
    
    if baselinecomparefails: 
        print banner
        print "The following tests failed the baseline comparison:"
        for t in baselinecomparefails:
            print t.testLine()
        print banner
    
    for test in cimetests:
        if test.testcomparestatus == 'FAIL':
            testcomparefails.append(test)
        if test.baselinecomparestatus == 'FAIL':
            baselinecomparefails.append(test)
    
    
    if passes:
        print banner
        print "These tests passed "
        print banner
        for p in passes:
            print p.testLine()
        print banner

    if runs:
        print banner
        print "These tests failed to finish running"
        print banner
        for r in runs:
            print r.testLine()
        print banner

    if sfails:
        print banner
        print "These tests had script errors" 
        print banner
        for s in sfails:
            print s.testLine()
        print banner

    if cfails:
        print banner
        print "These tests failed to compile"
        print banner
        for c in cfails:
            print c.testLine()
        print banner

def cimetestjson(cimetest):
    return cimetest.__dict__

def sendTestReport(suiteinfo, cimetests, tagname):
    #pass
    #print suiteinfo
    #print suiteinfo['machine']
    #for test in cimetests:
    #    print test.testLine()
    #suiteinfo.pop("testlist",None)
    
    testrecord = ElementTree.Element('testrecord')
    mach = ElementTree.SubElement(testrecord, 'mach', text=suiteinfo['machine'])
    compiler = ElementTree.SubElement(testrecord, 'compiler', text=suiteinfo['compiler'])
    mpilib = ElementTree.SubElement(testrecord, 'mpilib', text=suiteinfo['mpilib'])
    testroot = ElementTree.SubElement(testrecord, 'testroot', text=suiteinfo['testroot'])
    testtype = ElementTree.SubElement(testrecord, 'testtype', text=suiteinfo['testtype'])
    baselinetag = ElementTree.SubElement(testrecord, 'baselinetag', text=suiteinfo['baselinetag'])
    
    #for test in cimetests:
    #    testelement = ElementTree.Element('test',  {name : test.testname, overallstatus : test.overallstatus})
    #    #outputelement
    #    testrecord.append(testelement)

    testrecord.dump()

#------------------------------------------------------------------------------
# main function
#------------------------------------------------------------------------------
def main():
    parser = argparse.ArgumentParser(description='cs.status options')

    parser.add_argument('-i', '--testid', help='test id of the particular test suite', required=False)
    parser.add_argument('-s', '--summary', action='store_true', help='Generate summary', required=False)
    #parser.add_argument('-t', '--sendtestreport', action='store_true', help='Send the test report to CSEG\'s Test Database', required=False)
    #parser.add_argument('-a', '--tagname', help="The tag name under test" , required=False)
    tgroup = parser.add_argument_group('testreport')
    tgroup.add_argument('-t', '--testreport', action='store_true', help='Send the test report to CSEG\'s Test Database', required=False)
    tgroup.add_argument( '--tagname', help='Send the test report to CSEG\'s Test Database', required=False)
    tgroup.add_argument( '--testtype', help='Send the test report to CSEG\'s Test Database', required=False)
    
    
    args = parser.parse_args()
    #print args
    
    # get info needed to process the test status
    suiteinfo = getSuiteInfo(args)
    
    # Now check each test, get the status of each test. 
    cimetests = getTestStatuses(suiteinfo)
    
    if(args.summary==True):
        printSummary(suiteinfo, cimetests)
    elif(args.testreport==True):
        tagname = args.tagname
        print "tagname ", tagname
        sendTestReport(suiteinfo, cimetests, tagname)
    else:
        printStatus(cimetests)
    
if __name__ == "__main__":
    main()

