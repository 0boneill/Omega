#!/usr/bin/env perl 

use strict;
use warnings;
use Data::Dumper;

my $toolsdir = "./Tools";
push(@INC, $toolsdir);
require ConfigCase;

my %config = ConfigCase->getAllResolved();
my $machine = $config{'MACH'};
my $machroot = $config{'CCSM_MACHDIR'};
my $caseroot = $config{'CASEROOT'};
my $perl5lib = "$config{'CIMEROOT'}/utils/perl5lib";
push(@INC, $perl5lib);
require Batch::BatchUtils;
require Module::ModuleLoader;
my $lastjobid = undef;
sub main
{
	# Check the case only once..
	print "checking the case..\n";
	open(my $CHECKCASE, "-|", "./check_case");
	while(<$CHECKCASE>)
	{
		print "$_";
	}
	wait;
	
	my $moduleloader = new Module::ModuleLoader(machine => $config{'MACH'}, compiler => $config{'COMPILER'},
                                            mpilib => $config{'MPILIB'}, debug => $config{'DEBUG'},
                                            scriptsroot => $config{'SCRIPTSROOT'}, caseroot => $config{'CASEROOT'});
        $moduleloader->loadModules();

	my $batchutils = new Batch::BatchUtils(machine => $machine, machroot => $machroot, caseroot => $caseroot, caseconfig => \%config);
	
	$batchutils->dependencyCheck();
	$batchutils->submitJobs();
}

main(@ARGV) unless caller();
