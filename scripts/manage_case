#!/usr/bin/env python2.7
#FIXME - the above needs the explicit python2.7 - this is not general ???

from Tools.standard_script_setup import *

from CIME.utils         import expect, get_model
from CIME.XML.files     import Files
from CIME.XML.component import Component
from CIME.XML.compsets  import Compsets
from CIME.XML.grids     import Grids
from CIME.XML.machines  import Machines

import argparse, doctest

###############################################################################
def query_grids():  
###############################################################################

    files = Files()
    config_file = files.get_value("GRIDS_SPEC_FILE", resolved=True)
    expect(os.path.isfile(config_file),
           "Cannot find config_file %s on disk" %config_file)

    parsed_xml = Grids(config_file)
    if verbose:
        parsed_xml.print_values(verbose=verbose)
    else:
        parsed_xml.print_values()

###############################################################################
def query_machines():  
###############################################################################

    files = Files()
    config_file = files.get_value("MACHINES_SPEC_FILE", resolved=True)
    expect(os.path.isfile(config_file),
           "Cannot find config_file %s on disk" %config_file)

    parsed_xml = Machines(config_file)
    if verbose:
        parsed_xml.print_values(verbose=verbose)
    else:
        parsed_xml.print_values()

###############################################################################
def query_compsets(name):  
###############################################################################

    # Determine valid component values by checking the value attributes for COMPSETS_SPEC_FILE
    files = Files()
    components = files.get_components("COMPSETS_SPEC_FILE", resolved=True)
    match_found = "unset"
    for component in components:
        if component == name:
            match_found = component
            break

    # If name is not a valid argument - exit with error
    expect(match_found != "unset", 
           "Invalid input argument %s, valid input arguments are %s" % (name, components))

    # Determine the config_file for the target component 
    config_file = files.get_value("COMPSETS_SPEC_FILE", attribute={"component":name}, resolved=True)
    expect((config_file),
           "Cannot find any config_component.xml file for %s" %name)

    # Check that file exists on disk
    expect(os.path.isfile(config_file),
           "Cannot find config_file %s on disk" %config_file)

    # Now parse the compsets file and write out the compset alias and longname as well as the help text
    # determine component xml content 
    parsed_xml = Compsets(config_file)
    parsed_xml.print_values()

###############################################################################
def query_component(name):
###############################################################################

    # Determine the valid component classes (e.g. atm) for the driver/cpl
    # These are then stored in comps_array
    files = Files()
    infile = files.get_value("CONFIG_DRV_FILE")
    comps_object = Component(infile)
    comps_array = comps_object.get_value("component")
    
    # Loop through the elements for each component class (in config_files.xml) 
    # and see if there is a match for the the target component in the component attribute 
    match_found = False
    valid_components = list()
    for comp in comps_array:
        string = "CONFIG_%s_FILE"%comp 

        # determine all components in string
        components = files.get_components(string, resolved=True)
        for item in components:
            valid_components.append(item)

        # determine if config_file is on disk
        config_file = files.get_value(string, attribute={"component":name}, resolved=True)
        if config_file is not None:
            match_found = True
            expect(os.path.isfile(config_file),
                   "Cannot find config_file %s on disk" %config_file)
            break

    # If name is not a valid argument - exit with error
    expect((match_found), 
           "Invalid input argument %s, valid input arguments are %s" % (name, valid_components))

    # Check that file exists on disk, if not exit with error
    expect((config_file),
           "Cannot find any config_component.xml file for %s" %name)

    # determine component xml content 
    parsed_xml = Component(config_file)
    parsed_xml.print_values()

###############################################################################
def parse_command_line(args):
###############################################################################

    cime_model = CIME.utils.get_model()

    parser = argparse.ArgumentParser()

    CIME.utils.setup_standard_logging_options(parser)

    parser.add_argument("--query_compsets_setby", 
                        help="Query compsets that are set by the target component for %s model"%cime_model)

    parser.add_argument("--query_component_name", 
                        help="Query component settings that are set by the target component for %s model"%cime_model)

    parser.add_argument("--query_grids", action="store_true",
                        help="Query supported model grids for %s model" %cime_model)  

    parser.add_argument("--grids_shortname", 
                        help="Query model grids for input grid short name for %s model - not implemented yet" %cime_model)  

    parser.add_argument("--grids_alias", 
                        help="Query model grids for input grid  alias for %s model - not implemented yet" %cime_model)  

    parser.add_argument("--query_machines", action="store_true", 
                        help="Query supported machines for %s model" %cime_model)  

    args = parser.parse_args()

    CIME.utils.handle_standard_logging_options(args)

    return args

###############################################################################

args = parse_command_line(sys.argv)

verbose = args.verbose

if args.query_grids:
    query_grids()

if args.query_compsets_setby:
    query_compsets(name=args.query_compsets_setby)

if args.query_component_name:
    query_component(name=args.query_component_name)

if args.query_machines:
    query_machines()



